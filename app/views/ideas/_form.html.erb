<%= form_with(model: idea, local: true, html: { class: 'idea-form' }) do |form| %>
  <% if idea.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(idea.errors.count, "error") %> が発生しました:</h4>
      <ul>
        <% idea.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card mb-4">
    <div class="card-body">
      <h3 class="card-title h5 mb-3"><%= idea.new_record? ? '新しい投稿 (New post)' : '投稿を編集 (Edit post)' %></h3>

      <div class="mb-3">
        <%= form.label :name, 'タイトル (Title)', class: 'form-label' %>
        <%= form.text_field :name, class: 'form-control', placeholder: '例: 松江城に行ってきました (e.g. Visited Matsue Castle)' %>
      </div>

      <div class="mb-3">
        <%= form.label :description, '説明 (Description)', class: 'form-label' %>
        <%= form.text_area :description, class: 'form-control', rows: 4, placeholder: '感想やおすすめポイントを入力してください (Share your impressions or tips)' %>
      </div>

      <div class="mb-3">
        <%= form.label :picture, '画像 (Image)', class: 'form-label' %>
        <div class="d-flex align-items-center gap-2">
          <label class="btn btn-outline-secondary mb-0">
            画像を選択 (Choose image)
            <%= form.file_field :picture, class: 'd-none', accept: 'image/*', onchange: 'handleImageInput(this)' %>
          </label>
          <span id="picture-name" class="text-muted small"><%= idea.picture? ? File.basename(idea.picture_url.to_s) : 'ファイル未選択 (No file chosen)' %></span>
        </div>
        <div class="mt-3">
          <% if idea.picture? %>
            <%= image_tag idea.picture_url, id: 'picture-preview', class: 'img-thumbnail', style: 'max-width:200px;', alt: '画像プレビュー (Image preview)' %>
          <% else %>
            <img id="picture-preview" src="" alt="画像プレビュー (Image preview)" class="img-thumbnail d-none" style="max-width:200px;" />
          <% end %>
        </div>
      </div>

      <div class="d-flex justify-content-end">
        <% if idea.new_record? %>
          <%= form.submit 'コメントを作成 (Create Comment)', class: 'btn btn-primary' %>
        <% else %>
          <%= form.submit '投稿を更新 (Update Idea)', class: 'btn btn-primary' %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<script>
  function handleImageInput(input){
    var file = input.files && input.files[0];
    var nameSpan = document.getElementById('picture-name');
    var preview = document.getElementById('picture-preview');
    if(file){
      nameSpan.textContent = file.name;
      var reader = new FileReader();
      reader.onload = function(e){
        preview.src = e.target.result;
        preview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    } else {
      nameSpan.textContent = 'ファイル未選択';
      if(preview){ preview.src = ''; preview.classList.add('d-none'); }
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    var input = document.querySelector('.idea-form input[type=file]');
    if(input && input.files && input.files.length > 0){ handleImageInput(input); }
  });
</script>
